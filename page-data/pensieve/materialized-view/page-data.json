{"componentChunkName":"component---src-templates-post-js","path":"/pensieve/materialized-view","result":{"data":{"markdownRemark":{"html":"<p>Datalake On-promise a Societe Generale, on utilise Hive 4.0(Cloudera version 7.x) et Trino/Starburst Cluster pour faire des requetages analytiques, dans ce context, je partis en pilot pour faire la comparaison entre les deux view materilise:</p>\n<ul>\n<li>Travaille avec l'equipe infrastructure Datalake(LUCID) pour relever des problemes rencontree.</li>\n<li>Partage des retours avec l'editor Starburst/Trino pour les pointes bloquant au niveau d'activation Cache Service, Data Product et aussi la securite (impersonation)</li>\n<li>Implemtation sur la DEV pour la partie technique et sur la PRD pour la partie performance.</li>\n</ul>\n<h2>HIVE</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DROP</span> MATERIALIZED <span class=\"token keyword\">VIEW</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>multiapp_control_materialized_view<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DESCRIBE</span> FORMATTED prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>multiapp_control_materialized_view<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> MATERIALIZED <span class=\"token keyword\">VIEW</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>multiapp_control_materialized_view PARTITIONED <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">(</span>fiscal_year<span class=\"token punctuation\">)</span>\nstored <span class=\"token keyword\">as</span> orc\nlocation <span class=\"token string\">'/prd/uv/ptv_a8688/uv_ptv_a8688_proratavat/anh_test_materialized_view/multi_app_control'</span>\n<span class=\"token keyword\">as</span>\n<span class=\"token keyword\">with</span> gl <span class=\"token keyword\">as</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">select</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span>\n\t  \tcode_pci<span class=\"token punctuation\">,</span>\n\t  \taltacct_descr<span class=\"token punctuation\">,</span>\n\t\tSORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_array_brute<span class=\"token punctuation\">,</span>\n\t\tCONCAT_WS<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">,</span> SORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_liste_brute<span class=\"token punctuation\">,</span>\n\t\tSORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_array_brute\n\t<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token keyword\">select</span>\n\t\t\tuv<span class=\"token punctuation\">.</span>fiscal_year<span class=\"token punctuation\">,</span> \t\n\t\t\tcode_pci<span class=\"token punctuation\">,</span>\n\t\t\taltacct_descr<span class=\"token punctuation\">,</span>\n\t\t\tsource<span class=\"token punctuation\">,</span>\n\t\t\ttrim<span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">)</span> event_nature\n\t\t<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span> \n\t\t\t<span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span>\n\t\t\t\tfiscal_year<span class=\"token punctuation\">,</span>\n\t\t\t\tcast<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">(</span>accounting_period<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> accounting_period<span class=\"token punctuation\">,</span> substr<span class=\"token punctuation\">(</span>accounting_period<span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> accounting_period_2<span class=\"token punctuation\">,</span>\n\t\t\t\taltacct code_pci<span class=\"token punctuation\">,</span>\n\t\t\t\taltacct_descr<span class=\"token punctuation\">,</span>\n\t\t\t\tsource<span class=\"token punctuation\">,</span>\n\t\t\t\tevent_nature\n\t\t\t<span class=\"token keyword\">from</span> prd_suv_fni_a8401_glapf<span class=\"token punctuation\">.</span>suv_glapf \n\t \t\t<span class=\"token keyword\">where</span> business_unit\t<span class=\"token operator\">=</span> <span class=\"token string\">'G0001'</span> \n\t  \t  \t  <span class=\"token operator\">and</span> cast<span class=\"token punctuation\">(</span>fiscal_year <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> \t<span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t\t\t  <span class=\"token operator\">and</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> fiscal_year <span class=\"token operator\">=</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t\tcast<span class=\"token punctuation\">(</span>accounting_period <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">between</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> \n\t\t\t\t\t\t<span class=\"token operator\">or</span> accounting_period <span class=\"token operator\">=</span> concat<span class=\"token punctuation\">(</span><span class=\"token string\">'9'</span><span class=\"token punctuation\">,</span> lpad<span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n\t\t\t\t\t<span class=\"token punctuation\">,</span>\n\t\t\t\t\t\tcast<span class=\"token punctuation\">(</span>accounting_period <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">between</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token number\">12</span>\n\t\t\t\t\t\t<span class=\"token operator\">or</span> accounting_period <span class=\"token operator\">=</span> <span class=\"token string\">'912'</span><span class=\"token punctuation\">)</span>\t\t\t  \n\t\t      <span class=\"token operator\">and</span> ledger \t\t\t\t\t\t<span class=\"token operator\">=</span> <span class=\"token string\">'ACTUAL7003'</span>\n\t  \t      <span class=\"token operator\">and</span> origine \t\t\t\t\t\t<span class=\"token operator\">!=</span> <span class=\"token string\">'QTZ'</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t\t      <span class=\"token operator\">and</span> source \t\t\t\t\t\t<span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'RVM'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MIG'</span><span class=\"token punctuation\">)</span>\n\t\t\t  <span class=\"token operator\">and</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t    <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'991'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'992'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'994'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'995'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">--filtrer les comptes de bilan</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t\t\t\t  </span>\n\t\t\t  <span class=\"token comment\">--PNL &amp; BILAN</span>\n\t\t      <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>\n\t\t           substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t\t<span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'976'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'977'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'986'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'987'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'996'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'997'</span><span class=\"token punctuation\">)</span>\n\t\t        <span class=\"token operator\">or</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>        <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'979'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'989'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\t\t\t  \n\t\t<span class=\"token punctuation\">)</span> uv\n\t\t<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span> \n\t\t\t<span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> \n\t\t\t\tcast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span> fiscal_year<span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> accounting_period<span class=\"token punctuation\">,</span>\n\t\t\t\tcomptepci_numero<span class=\"token punctuation\">,</span>\n\t\t\t\tcpt_codepcec \n\t\t\t<span class=\"token keyword\">from</span> prd_srv_nsa_a2274_nosica<span class=\"token punctuation\">.</span>sv_nsa_fnichartacc refe\n\t\t\t<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span>\t\t\t\t\t\t\n\t\t\t\t<span class=\"token keyword\">select</span> \n\t\t\t\t\t<span class=\"token function\">max</span><span class=\"token punctuation\">(</span>insert_date<span class=\"token punctuation\">)</span> max_insert_date<span class=\"token punctuation\">,</span>\n\t\t\t\t    cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> fiscal_year   \n\t\t\t\t<span class=\"token keyword\">from</span> prd_srv_nsa_a2274_nosica<span class=\"token punctuation\">.</span>sv_nsa_fnichartacc\n\t\t\t\t<span class=\"token keyword\">where</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">)</span> refe_max\n\t\t\t\t<span class=\"token keyword\">on</span> refe<span class=\"token punctuation\">.</span>insert_date <span class=\"token operator\">=</span> refe_max<span class=\"token punctuation\">.</span>max_insert_date\n\t\t\t\t<span class=\"token operator\">and</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>refe<span class=\"token punctuation\">.</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> refe_max<span class=\"token punctuation\">.</span>fiscal_year\n\t\t\t<span class=\"token keyword\">where</span> cpt_codepcec <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'699'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'799'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'000000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'001000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'002000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'003000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'004000'</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span> wi\n\t\t\t<span class=\"token keyword\">on</span> uv<span class=\"token punctuation\">.</span>fiscal_year \t\t\t<span class=\"token operator\">=</span> wi<span class=\"token punctuation\">.</span>fiscal_year\n\t\t\t<span class=\"token operator\">and</span> uv<span class=\"token punctuation\">.</span>code_pci \t\t\t<span class=\"token operator\">=</span> wi<span class=\"token punctuation\">.</span>comptepci_numero\n\t<span class=\"token punctuation\">)</span> uv2\n\t<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span> \t\n\t\tcode_pci<span class=\"token punctuation\">,</span>\n\t\taltacct_descr\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nprorata <span class=\"token keyword\">as</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">select</span> \n\t    fiscal_year<span class=\"token punctuation\">,</span>\n\t    altacct <span class=\"token keyword\">as</span> code_pci<span class=\"token punctuation\">,</span>\n\t    SORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span><span class=\"token keyword\">coalesce</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_array_prorata<span class=\"token punctuation\">,</span>\n\t\tCONCAT_WS<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">,</span> SORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_liste_prorata<span class=\"token punctuation\">,</span>\n\t\tSORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span><span class=\"token keyword\">coalesce</span><span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">,</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_array_prorata<span class=\"token punctuation\">,</span>\n\t\tCONCAT_WS<span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">,</span> SORT_ARRAY<span class=\"token punctuation\">(</span>COLLECT_SET<span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_liste_prorata\n\t<span class=\"token keyword\">from</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>uv_proratavat\n\t<span class=\"token keyword\">where</span> cast<span class=\"token punctuation\">(</span>fiscal_year <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t  <span class=\"token operator\">and</span> origine \t\t<span class=\"token operator\">!=</span> <span class=\"token string\">'QTZ'</span>\n\t  <span class=\"token comment\">-- Avant retraitement</span>\n\t  <span class=\"token operator\">and</span> nom_retraitement <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span>\n\t  <span class=\"token comment\">--PNL &amp; BILAN</span>\n\t  <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'976'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'977'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'986'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'987'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'996'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'997'</span><span class=\"token punctuation\">)</span>\n\t   <span class=\"token operator\">or</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'979'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'989'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t  <span class=\"token operator\">and</span> source \t\t\t\t\t\t<span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'RVM'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MIG'</span><span class=\"token punctuation\">)</span>\n\t  <span class=\"token operator\">and</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t    <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'991'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'992'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'994'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'995'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">--filtrer les comptes de bilan</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t\t\t   </span>\n\t  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span> \n\t\taltacct \n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nresult <span class=\"token keyword\">as</span> <span class=\"token punctuation\">(</span>\n<span class=\"token keyword\">select</span> gl2<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata<span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>event_nature_liste_prorata<span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>event_nature_array_prorata<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>prorata<span class=\"token punctuation\">.</span>code_pci <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'KO'</span><span class=\"token punctuation\">)</span> pci_in_prorata<span class=\"token punctuation\">,</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t<span class=\"token comment\">--if(gl2.multiappl_liste_brute = prorata.multiappl_liste_prorata, 'OK','KO') all_appl_srce_in_prorata,</span>\n\t<span class=\"token keyword\">case</span> \n\t\t<span class=\"token keyword\">when</span> gl2<span class=\"token punctuation\">.</span>multiappl_liste_brute <span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata <span class=\"token keyword\">then</span> <span class=\"token string\">'OK'</span>\n\t\t<span class=\"token keyword\">when</span> prorata<span class=\"token punctuation\">.</span>code_pci <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'N/A'</span>\n\t\t<span class=\"token keyword\">else</span> <span class=\"token string\">'KO'</span>\n\t<span class=\"token keyword\">end</span> all_appl_srce_in_prorata\n<span class=\"token comment\">--END UPDATE JMC 20230317\t   </span>\n       <span class=\"token comment\">--array_intersect(gl2.multiappl_array_brute,prorata.multiappl_array_prorata) source_g_ds_prorata,</span>\n       <span class=\"token comment\">--if( prorata.multiappl_liste_prorata is null, gl2.multiappl_array_brute, array_except(gl2.multiappl_array_brute,prorata.multiappl_array_prorata) ) source_gl_pas_ds_prorata,</span>\n       <span class=\"token comment\">--if( prorata.event_nature_liste_prorata is null, gl2.event_nature_array_brute, array_except(gl2.event_nature_array_brute,prorata.event_nature_array_prorata) ) event_nat_gl_pas_ds_prorata</span>\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span> \n\t<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n\t<span class=\"token keyword\">from</span> gl\n\t<span class=\"token keyword\">where</span> INSTR<span class=\"token punctuation\">(</span>multiappl_liste_brute<span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span><span class=\"token number\">0</span>\n<span class=\"token punctuation\">)</span> gl2\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> prorata\n\t<span class=\"token keyword\">on</span> gl2<span class=\"token punctuation\">.</span>fiscal_year\t<span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>fiscal_year\n\t<span class=\"token operator\">and</span> gl2<span class=\"token punctuation\">.</span>code_pci \t<span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>code_pci\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">select</span> fiscal_year<span class=\"token punctuation\">,</span>code_pci<span class=\"token punctuation\">,</span>altacct_descr<span class=\"token punctuation\">,</span>multiappl_array_brute<span class=\"token punctuation\">,</span>multiappl_liste_brute<span class=\"token punctuation\">,</span>event_nature_array_brute<span class=\"token punctuation\">,</span>multiappl_liste_prorata<span class=\"token punctuation\">,</span>multiappl_array_prorata<span class=\"token punctuation\">,</span>pci_in_prorata<span class=\"token punctuation\">,</span>all_appl_srce_in_prorata<span class=\"token punctuation\">,</span>\n\tcollect_set<span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> ARRAY_CONTAINS<span class=\"token punctuation\">(</span>multiappl_array_prorata<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>elem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">THEN</span> e<span class=\"token punctuation\">.</span>elem <span class=\"token keyword\">ELSE</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> source_g_ds_prorata<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> multiappl_liste_prorata <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> multiappl_array_brute<span class=\"token punctuation\">,</span> collect_set<span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> ARRAY_CONTAINS<span class=\"token punctuation\">(</span>multiappl_array_prorata<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>elem<span class=\"token punctuation\">)</span> <span class=\"token keyword\">THEN</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">ELSE</span> e<span class=\"token punctuation\">.</span>elem <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> source_gl_pas_ds_prorata<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> event_nature_liste_prorata <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> event_nature_array_brute<span class=\"token punctuation\">,</span> collect_set<span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> ARRAY_CONTAINS<span class=\"token punctuation\">(</span>event_nature_array_prorata<span class=\"token punctuation\">,</span> e1<span class=\"token punctuation\">.</span>elem1<span class=\"token punctuation\">)</span> <span class=\"token keyword\">THEN</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">ELSE</span> e1<span class=\"token punctuation\">.</span>elem1 <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> event_nat_gl_pas_ds_prorata\n<span class=\"token keyword\">from</span> result\nLATERAL <span class=\"token keyword\">VIEW</span> EXPLODE<span class=\"token punctuation\">(</span>multiappl_array_brute<span class=\"token punctuation\">)</span> e <span class=\"token keyword\">as</span> elem\nLATERAL <span class=\"token keyword\">VIEW</span> EXPLODE<span class=\"token punctuation\">(</span>event_nature_array_brute<span class=\"token punctuation\">)</span> e1 <span class=\"token keyword\">as</span> elem1\n<span class=\"token comment\">--where fiscal_year = '2022' or fiscal_year = '2021' or fiscal_year = '2020'</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> fiscal_year<span class=\"token punctuation\">,</span>code_pci<span class=\"token punctuation\">,</span>altacct_descr<span class=\"token punctuation\">,</span>multiappl_array_brute<span class=\"token punctuation\">,</span>multiappl_liste_brute<span class=\"token punctuation\">,</span>event_nature_array_brute<span class=\"token punctuation\">,</span>multiappl_liste_prorata<span class=\"token punctuation\">,</span>event_nature_liste_prorata<span class=\"token punctuation\">,</span>multiappl_array_prorata<span class=\"token punctuation\">,</span>pci_in_prorata<span class=\"token punctuation\">,</span>all_appl_srce_in_prorata\n<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> MATERIALIZED <span class=\"token keyword\">VIEW</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>multiapp_control_materialized_view REBUILD<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Trino View</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token operator\">or</span> <span class=\"token keyword\">replace</span> <span class=\"token keyword\">view</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>prorata_multiappl_control_brut_view_prorata_view SECURITY <span class=\"token keyword\">INVOKER</span> <span class=\"token keyword\">as</span> \n<span class=\"token comment\">--1 Comparaison base brute / base prorata sur PCI Multi application</span>\n<span class=\"token keyword\">with</span> gl <span class=\"token keyword\">as</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">select</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span>\n\t  \tcode_pci<span class=\"token punctuation\">,</span>\n\t  \taltacct_descr<span class=\"token punctuation\">,</span>\n\t\tARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_array_brute<span class=\"token punctuation\">,</span>\n\t\tARRAY_JOIN<span class=\"token punctuation\">(</span>ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> multiappl_liste_brute<span class=\"token punctuation\">,</span>\n\t\tARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> event_nature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_array_brute\n\t<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token keyword\">select</span>\n\t\t\tuv<span class=\"token punctuation\">.</span>fiscal_year<span class=\"token punctuation\">,</span> \t\n\t\t\tcode_pci<span class=\"token punctuation\">,</span>\n\t\t\taltacct_descr<span class=\"token punctuation\">,</span>\n\t\t\tsource<span class=\"token punctuation\">,</span>\n\t\t\ttrim<span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">)</span> event_nature\n\t\t<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span> \n\t\t\t<span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span>\n\t\t\t\tfiscal_year<span class=\"token punctuation\">,</span>\n\t\t\t\tcast<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">(</span>accounting_period<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> accounting_period<span class=\"token punctuation\">,</span> substr<span class=\"token punctuation\">(</span>accounting_period<span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> accounting_period_2<span class=\"token punctuation\">,</span>\n\t\t\t\taltacct code_pci<span class=\"token punctuation\">,</span>\n\t\t\t\taltacct_descr<span class=\"token punctuation\">,</span>\n\t\t\t\tsource<span class=\"token punctuation\">,</span>\n\t\t\t\tevent_nature\n\t\t\t<span class=\"token keyword\">from</span> prd_suv_fni_a8401_glapf<span class=\"token punctuation\">.</span>suv_glapf \n\t \t\t<span class=\"token keyword\">where</span> business_unit\t<span class=\"token operator\">=</span> <span class=\"token string\">'G0001'</span> \n\t  \t  \t  <span class=\"token operator\">and</span> cast<span class=\"token punctuation\">(</span>fiscal_year <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> \t<span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t\t\t  <span class=\"token operator\">and</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> fiscal_year <span class=\"token operator\">=</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t\tcast<span class=\"token punctuation\">(</span>accounting_period <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">between</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> \n\t\t\t\t\t\t<span class=\"token operator\">or</span> accounting_period <span class=\"token operator\">=</span> concat<span class=\"token punctuation\">(</span><span class=\"token string\">'9'</span><span class=\"token punctuation\">,</span> lpad<span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n\t\t\t\t\t<span class=\"token punctuation\">,</span>\n\t\t\t\t\t\tcast<span class=\"token punctuation\">(</span>accounting_period <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">between</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token number\">12</span>\n\t\t\t\t\t\t<span class=\"token operator\">or</span> accounting_period <span class=\"token operator\">=</span> <span class=\"token string\">'912'</span><span class=\"token punctuation\">)</span>\t\t\t  \n\t\t      <span class=\"token operator\">and</span> ledger \t\t\t\t\t\t<span class=\"token operator\">=</span> <span class=\"token string\">'ACTUAL7003'</span>\n\t  \t      <span class=\"token operator\">and</span> origine \t\t\t\t\t\t<span class=\"token operator\">!=</span> <span class=\"token string\">'QTZ'</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t\t      <span class=\"token operator\">and</span> source \t\t\t\t\t\t<span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'RVM'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MIG'</span><span class=\"token punctuation\">)</span>\n\t\t\t  <span class=\"token operator\">and</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t    <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'991'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'992'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'994'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'995'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">--filtrer les comptes de bilan</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t\t\t\t  </span>\n\t\t\t  <span class=\"token comment\">--PNL &amp; BILAN</span>\n\t\t      <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>\n\t\t           substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t\t<span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'976'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'977'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'986'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'987'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'996'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'997'</span><span class=\"token punctuation\">)</span>\n\t\t        <span class=\"token operator\">or</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>        <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'979'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'989'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\t\t\t  \n\t\t<span class=\"token punctuation\">)</span> uv\n\t\t<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span> \n\t\t\t<span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> \n\t\t\t\tcast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span> fiscal_year<span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> accounting_period<span class=\"token punctuation\">,</span>\n\t\t\t\tcomptepci_numero<span class=\"token punctuation\">,</span>\n\t\t\t\tcpt_codepcec \n\t\t\t<span class=\"token keyword\">from</span> prd_srv_nsa_a2274_nosica<span class=\"token punctuation\">.</span>sv_nsa_fnichartacc refe\n\t\t\t<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span>\t\t\t\t\t\t\n\t\t\t\t<span class=\"token keyword\">select</span> \n\t\t\t\t\t<span class=\"token function\">max</span><span class=\"token punctuation\">(</span>insert_date<span class=\"token punctuation\">)</span> max_insert_date<span class=\"token punctuation\">,</span>\n\t\t\t\t    cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> fiscal_year   \n\t\t\t\t<span class=\"token keyword\">from</span> prd_srv_nsa_a2274_nosica<span class=\"token punctuation\">.</span>sv_nsa_fnichartacc\n\t\t\t\t<span class=\"token keyword\">where</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">)</span> refe_max\n\t\t\t\t<span class=\"token keyword\">on</span> refe<span class=\"token punctuation\">.</span>insert_date <span class=\"token operator\">=</span> refe_max<span class=\"token punctuation\">.</span>max_insert_date\n\t\t\t\t<span class=\"token operator\">and</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>refe<span class=\"token punctuation\">.</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> refe_max<span class=\"token punctuation\">.</span>fiscal_year\n\t\t\t<span class=\"token keyword\">where</span> cpt_codepcec <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'699'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'799'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'000000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'001000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'002000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'003000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'004000'</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span> wi\n\t\t\t<span class=\"token keyword\">on</span> uv<span class=\"token punctuation\">.</span>fiscal_year \t\t\t<span class=\"token operator\">=</span> wi<span class=\"token punctuation\">.</span>fiscal_year\n\t\t\t<span class=\"token operator\">and</span> uv<span class=\"token punctuation\">.</span>code_pci \t\t\t<span class=\"token operator\">=</span> wi<span class=\"token punctuation\">.</span>comptepci_numero\n\t<span class=\"token punctuation\">)</span> uv2\n\t<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span> \t\n\t\tcode_pci<span class=\"token punctuation\">,</span>\n\t\taltacct_descr\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nprorata <span class=\"token keyword\">as</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">select</span> \n\t    fiscal_year<span class=\"token punctuation\">,</span>\n\t    altacct <span class=\"token keyword\">as</span> code_pci<span class=\"token punctuation\">,</span>\n\t    ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> <span class=\"token keyword\">coalesce</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_array_prorata<span class=\"token punctuation\">,</span>\n\t\tARRAY_JOIN<span class=\"token punctuation\">(</span>ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> multiappl_liste_prorata<span class=\"token punctuation\">,</span>\n\t\tARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> <span class=\"token keyword\">coalesce</span><span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">,</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_array_prorata<span class=\"token punctuation\">,</span>\n\t\tARRAY_JOIN<span class=\"token punctuation\">(</span>ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> event_nature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> event_nature_liste_prorata\n\t<span class=\"token keyword\">from</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>uv_proratavat\n\t<span class=\"token keyword\">where</span> cast<span class=\"token punctuation\">(</span>fiscal_year <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t  <span class=\"token operator\">and</span> origine \t\t<span class=\"token operator\">!=</span> <span class=\"token string\">'QTZ'</span>\n\t  <span class=\"token comment\">-- Avant retraitement</span>\n\t  <span class=\"token operator\">and</span> nom_retraitement <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span>\n\t  <span class=\"token comment\">--PNL &amp; BILAN</span>\n\t  <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'976'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'977'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'986'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'987'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'996'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'997'</span><span class=\"token punctuation\">)</span>\n\t   <span class=\"token operator\">or</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'979'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'989'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t  <span class=\"token operator\">and</span> source \t\t\t\t\t\t<span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'RVM'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MIG'</span><span class=\"token punctuation\">)</span>\n\t  <span class=\"token operator\">and</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t    <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'991'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'992'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'994'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'995'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">--filtrer les comptes de bilan</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t\t\t   </span>\n\t<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span> \n\t\taltacct \n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">select</span> gl2<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata<span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>prorata<span class=\"token punctuation\">.</span>code_pci <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'KO'</span><span class=\"token punctuation\">)</span> pci_in_prorata<span class=\"token punctuation\">,</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t<span class=\"token comment\">--if(gl2.multiappl_liste_brute = prorata.multiappl_liste_prorata, 'OK','KO') all_appl_srce_in_prorata,</span>\n\t<span class=\"token keyword\">case</span> \n\t\t<span class=\"token keyword\">when</span> gl2<span class=\"token punctuation\">.</span>multiappl_liste_brute <span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata <span class=\"token keyword\">then</span> <span class=\"token string\">'OK'</span>\n\t\t<span class=\"token keyword\">when</span> prorata<span class=\"token punctuation\">.</span>code_pci <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'N/A'</span>\n\t\t<span class=\"token keyword\">else</span> <span class=\"token string\">'KO'</span>\n\t<span class=\"token keyword\">end</span> all_appl_srce_in_prorata<span class=\"token punctuation\">,</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t   </span>\n       array_intersect<span class=\"token punctuation\">(</span>gl2<span class=\"token punctuation\">.</span>multiappl_array_brute<span class=\"token punctuation\">,</span>prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">)</span> source_g_ds_prorata<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> gl2<span class=\"token punctuation\">.</span>multiappl_array_brute<span class=\"token punctuation\">,</span> array_except<span class=\"token punctuation\">(</span>gl2<span class=\"token punctuation\">.</span>multiappl_array_brute<span class=\"token punctuation\">,</span>prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> source_gl_pas_ds_prorata<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> prorata<span class=\"token punctuation\">.</span>event_nature_liste_prorata <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> gl2<span class=\"token punctuation\">.</span>event_nature_array_brute<span class=\"token punctuation\">,</span> array_except<span class=\"token punctuation\">(</span>gl2<span class=\"token punctuation\">.</span>event_nature_array_brute<span class=\"token punctuation\">,</span>prorata<span class=\"token punctuation\">.</span>event_nature_array_prorata<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> event_nat_gl_pas_ds_prorata\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span> \n\t<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n\t<span class=\"token keyword\">from</span> gl\n\t<span class=\"token keyword\">where</span> strpos<span class=\"token punctuation\">(</span>multiappl_liste_brute<span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span><span class=\"token number\">0</span>\n<span class=\"token punctuation\">)</span> gl2\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> prorata\n\t<span class=\"token keyword\">on</span> gl2<span class=\"token punctuation\">.</span>fiscal_year\t<span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>fiscal_year\n\t<span class=\"token operator\">and</span> gl2<span class=\"token punctuation\">.</span>code_pci \t<span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>code_pci\n<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Starburst</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">SCHEMA</span> hive_default_lucid_dev<span class=\"token punctuation\">.</span>views_cache_storage <span class=\"token keyword\">WITH</span> <span class=\"token punctuation\">(</span>location <span class=\"token operator\">=</span> <span class=\"token string\">'/dev/suv/fni_a8401/suv_fni_a8401_accounting_granular/views_cache_storage/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">SCHEMA</span> hive_default_lucid_dev<span class=\"token punctuation\">.</span>views_schema <span class=\"token keyword\">WITH</span> <span class=\"token punctuation\">(</span>location <span class=\"token operator\">=</span> <span class=\"token string\">'/dev/suv/fni_a8401/suv_fni_a8401_accounting_granular/views_schemas'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> MATERIALIZED <span class=\"token keyword\">VIEW</span> hive_default_lucid_dev<span class=\"token punctuation\">.</span>tax_data<span class=\"token punctuation\">.</span>prorata_multiappl_control_brut_view_prorata_view\n<span class=\"token keyword\">WITH</span> <span class=\"token punctuation\">(</span>\n   grace_period <span class=\"token operator\">=</span> <span class=\"token string\">'10.00m'</span><span class=\"token punctuation\">,</span>\n   max_import_duration <span class=\"token operator\">=</span> <span class=\"token string\">'30.00m'</span><span class=\"token punctuation\">,</span>\n   refresh_interval <span class=\"token operator\">=</span> <span class=\"token string\">'12.00h'</span><span class=\"token punctuation\">,</span>\n   run_as_invoker <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span>\n<span class=\"token keyword\">select</span> gl2<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata<span class=\"token punctuation\">,</span>\n    prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>prorata<span class=\"token punctuation\">.</span>code_pci <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'KO'</span><span class=\"token punctuation\">)</span> pci_in_prorata<span class=\"token punctuation\">,</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t<span class=\"token comment\">--if(gl2.multiappl_liste_brute = prorata.multiappl_liste_prorata, 'OK','KO') all_appl_srce_in_prorata,</span>\n\t<span class=\"token keyword\">case</span> \n\t\t<span class=\"token keyword\">when</span> gl2<span class=\"token punctuation\">.</span>multiappl_liste_brute <span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata <span class=\"token keyword\">then</span> <span class=\"token string\">'OK'</span>\n\t\t<span class=\"token keyword\">when</span> prorata<span class=\"token punctuation\">.</span>code_pci <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'N/A'</span>\n\t\t<span class=\"token keyword\">else</span> <span class=\"token string\">'KO'</span>\n\t<span class=\"token keyword\">end</span> all_appl_srce_in_prorata<span class=\"token punctuation\">,</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t   </span>\n       array_intersect<span class=\"token punctuation\">(</span>gl2<span class=\"token punctuation\">.</span>multiappl_array_brute<span class=\"token punctuation\">,</span>prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">)</span> source_g_ds_prorata<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> prorata<span class=\"token punctuation\">.</span>multiappl_liste_prorata <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> gl2<span class=\"token punctuation\">.</span>multiappl_array_brute<span class=\"token punctuation\">,</span> array_except<span class=\"token punctuation\">(</span>gl2<span class=\"token punctuation\">.</span>multiappl_array_brute<span class=\"token punctuation\">,</span>prorata<span class=\"token punctuation\">.</span>multiappl_array_prorata<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> source_gl_pas_ds_prorata<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> prorata<span class=\"token punctuation\">.</span>event_nature_liste_prorata <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> gl2<span class=\"token punctuation\">.</span>event_nature_array_brute<span class=\"token punctuation\">,</span> array_except<span class=\"token punctuation\">(</span>gl2<span class=\"token punctuation\">.</span>event_nature_array_brute<span class=\"token punctuation\">,</span>prorata<span class=\"token punctuation\">.</span>event_nature_array_prorata<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> event_nat_gl_pas_ds_prorata\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span> \n\t<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n\t<span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">select</span> \n            fiscal_year<span class=\"token punctuation\">,</span>\n            code_pci<span class=\"token punctuation\">,</span>\n            altacct_descr<span class=\"token punctuation\">,</span>\n            ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_array_brute<span class=\"token punctuation\">,</span>\n            ARRAY_JOIN<span class=\"token punctuation\">(</span>ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> multiappl_liste_brute<span class=\"token punctuation\">,</span>\n            ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> event_nature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_array_brute\n        <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">select</span>\n                uv<span class=\"token punctuation\">.</span>fiscal_year<span class=\"token punctuation\">,</span> \t\n                code_pci<span class=\"token punctuation\">,</span>\n                altacct_descr<span class=\"token punctuation\">,</span>\n                source<span class=\"token punctuation\">,</span>\n                trim<span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">)</span> event_nature\n            <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span> \n                <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span>\n                    fiscal_year<span class=\"token punctuation\">,</span>\n                    cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">(</span>accounting_period<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> accounting_period<span class=\"token punctuation\">,</span> substr<span class=\"token punctuation\">(</span>accounting_period<span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> accounting_period_2<span class=\"token punctuation\">,</span>\n                    altacct code_pci<span class=\"token punctuation\">,</span>\n                    altacct_descr<span class=\"token punctuation\">,</span>\n                    source<span class=\"token punctuation\">,</span>\n                    event_nature\n                <span class=\"token keyword\">from</span> prd_suv_fni_a8401_glapf<span class=\"token punctuation\">.</span>suv_glapf \n                <span class=\"token keyword\">where</span> business_unit\t<span class=\"token operator\">=</span> <span class=\"token string\">'G0001'</span> \n                <span class=\"token operator\">and</span> cast<span class=\"token punctuation\">(</span>fiscal_year <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> \t<span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n                <span class=\"token operator\">and</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> fiscal_year <span class=\"token operator\">=</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n                            cast<span class=\"token punctuation\">(</span>accounting_period <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">between</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> \n                            <span class=\"token operator\">or</span> accounting_period <span class=\"token operator\">=</span> concat<span class=\"token punctuation\">(</span><span class=\"token string\">'9'</span><span class=\"token punctuation\">,</span> lpad<span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n                        <span class=\"token punctuation\">,</span>\n                            cast<span class=\"token punctuation\">(</span>accounting_period <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">between</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token number\">12</span>\n                            <span class=\"token operator\">or</span> accounting_period <span class=\"token operator\">=</span> <span class=\"token string\">'912'</span><span class=\"token punctuation\">)</span>\t\t\t  \n                <span class=\"token operator\">and</span> ledger \t\t\t\t\t\t<span class=\"token operator\">=</span> <span class=\"token string\">'ACTUAL7003'</span>\n                <span class=\"token operator\">and</span> origine \t\t\t\t\t\t<span class=\"token operator\">!=</span> <span class=\"token string\">'QTZ'</span>\n    <span class=\"token comment\">--UPDATE JMC 20230317</span>\n                <span class=\"token operator\">and</span> source \t\t\t\t\t\t<span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'RVM'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MIG'</span><span class=\"token punctuation\">)</span>\n                <span class=\"token operator\">and</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t    <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'991'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'992'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'994'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'995'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">--filtrer les comptes de bilan</span>\n    <span class=\"token comment\">--END UPDATE JMC 20230317\t\t\t\t  </span>\n                <span class=\"token comment\">--PNL &amp; BILAN</span>\n                <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>\n                    substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t\t<span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'976'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'977'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'986'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'987'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'996'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'997'</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token operator\">or</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>        <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'979'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'989'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\t\t\t  \n            <span class=\"token punctuation\">)</span> uv\n            <span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span> \n                <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> \n                    cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span> fiscal_year<span class=\"token punctuation\">,</span>\n                    <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> accounting_period<span class=\"token punctuation\">,</span>\n                    comptepci_numero<span class=\"token punctuation\">,</span>\n                    cpt_codepcec \n                <span class=\"token keyword\">from</span> prd_srv_nsa_a2274_nosica<span class=\"token punctuation\">.</span>sv_nsa_fnichartacc refe\n                <span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span>\t\t\t\t\t\t\n                    <span class=\"token keyword\">select</span> \n                        <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>insert_date<span class=\"token punctuation\">)</span> max_insert_date<span class=\"token punctuation\">,</span>\n                        cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> fiscal_year   \n                    <span class=\"token keyword\">from</span> prd_srv_nsa_a2274_nosica<span class=\"token punctuation\">.</span>sv_nsa_fnichartacc\n                    <span class=\"token keyword\">where</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span> refe_max\n                    <span class=\"token keyword\">on</span> refe<span class=\"token punctuation\">.</span>insert_date <span class=\"token operator\">=</span> refe_max<span class=\"token punctuation\">.</span>max_insert_date\n                    <span class=\"token operator\">and</span> cast<span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>refe<span class=\"token punctuation\">.</span>insert_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> refe_max<span class=\"token punctuation\">.</span>fiscal_year\n                <span class=\"token keyword\">where</span> cpt_codepcec <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'699'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'799'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'000000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'001000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'002000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'003000'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'004000'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span> wi\n                <span class=\"token keyword\">on</span> uv<span class=\"token punctuation\">.</span>fiscal_year \t\t\t<span class=\"token operator\">=</span> wi<span class=\"token punctuation\">.</span>fiscal_year\n                <span class=\"token operator\">and</span> uv<span class=\"token punctuation\">.</span>code_pci \t\t\t<span class=\"token operator\">=</span> wi<span class=\"token punctuation\">.</span>comptepci_numero\n        <span class=\"token punctuation\">)</span> uv2\n        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> \n            fiscal_year<span class=\"token punctuation\">,</span> \t\n            code_pci<span class=\"token punctuation\">,</span>\n            altacct_descr\n    <span class=\"token punctuation\">)</span> gl\n\t<span class=\"token keyword\">where</span> strpos<span class=\"token punctuation\">(</span>multiappl_liste_brute<span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span><span class=\"token number\">0</span>\n<span class=\"token punctuation\">)</span> gl2\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">select</span> \n\t    fiscal_year<span class=\"token punctuation\">,</span>\n\t    altacct <span class=\"token keyword\">as</span> code_pci<span class=\"token punctuation\">,</span>\n\t    ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> <span class=\"token keyword\">coalesce</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> multiappl_array_prorata<span class=\"token punctuation\">,</span>\n\t\tARRAY_JOIN<span class=\"token punctuation\">(</span>ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> multiappl_liste_prorata<span class=\"token punctuation\">,</span>\n\t\tARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> <span class=\"token keyword\">coalesce</span><span class=\"token punctuation\">(</span>event_nature<span class=\"token punctuation\">,</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> event_nature_array_prorata<span class=\"token punctuation\">,</span>\n\t\tARRAY_JOIN<span class=\"token punctuation\">(</span>ARRAY_SORT<span class=\"token punctuation\">(</span>ARRAY_AGG<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> event_nature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span> event_nature_liste_prorata\n\t<span class=\"token keyword\">from</span> prd_uv_ptv_a8688_proratavat<span class=\"token punctuation\">.</span>uv_proratavat\n\t<span class=\"token keyword\">where</span> cast<span class=\"token punctuation\">(</span>fiscal_year <span class=\"token keyword\">as</span> <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">current_date</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">)</span>\n\t  <span class=\"token operator\">and</span> origine \t\t<span class=\"token operator\">!=</span> <span class=\"token string\">'QTZ'</span>\n\t  <span class=\"token comment\">-- Avant retraitement</span>\n\t  <span class=\"token operator\">and</span> nom_retraitement <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span>\n\t  <span class=\"token comment\">--PNL &amp; BILAN</span>\n\t  <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'976'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'977'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'986'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'987'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'996'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'997'</span><span class=\"token punctuation\">)</span>\n\t   <span class=\"token operator\">or</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'979'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'989'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'999'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">--UPDATE JMC 20230317</span>\n\t  <span class=\"token operator\">and</span> source \t\t\t\t\t\t<span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'RVM'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MIG'</span><span class=\"token punctuation\">)</span>\n\t  <span class=\"token operator\">and</span> substr<span class=\"token punctuation\">(</span>altacct<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> \t    <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'991'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'992'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'994'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'995'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">--filtrer les comptes de bilan</span>\n<span class=\"token comment\">--END UPDATE JMC 20230317\t\t\t   </span>\n\t<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> \n\t\tfiscal_year<span class=\"token punctuation\">,</span> \n\t\taltacct \n<span class=\"token punctuation\">)</span> prorata\n\t<span class=\"token keyword\">on</span> gl2<span class=\"token punctuation\">.</span>fiscal_year\t<span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>fiscal_year\n\t<span class=\"token operator\">and</span> gl2<span class=\"token punctuation\">.</span>code_pci \t<span class=\"token operator\">=</span> prorata<span class=\"token punctuation\">.</span>code_pci\n<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> MATERIALIZED <span class=\"token keyword\">VIEW</span> hive_default_lucid_dev<span class=\"token punctuation\">.</span>tax_data<span class=\"token punctuation\">.</span>prorata_multiappl_control_brut_view_prorata_view <span class=\"token keyword\">SET</span> PROPERTIES partitioning <span class=\"token operator\">=</span> ARRAY<span class=\"token punctuation\">[</span><span class=\"token string\">'fiscal_year'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\nREFRESH MATERIALIZED <span class=\"token keyword\">VIEW</span> hive_default_lucid_dev<span class=\"token punctuation\">.</span>tax_data<span class=\"token punctuation\">.</span>prorata_multiappl_control_brut_view_prorata_view<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"system\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"metadata\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"materialized_views\"</span> <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Resources</h2>","frontmatter":{"title":"Hive & Trino Materialized View","description":"Using Materialized View to improve query result for end client.","date":"2023-02-01T00:00:00.000Z","slug":"/pensieve/materialized-view","tags":["Hive","Trino","Materialized View"]}}},"pageContext":{}},"staticQueryHashes":["1994492073","2009693873","2031412112","3825832676"]}